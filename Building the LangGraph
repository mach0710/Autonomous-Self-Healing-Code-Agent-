from langgraph.graph import StateGraph, END

# Define flow logic
def should_continue(state: AgentState):
    if state['success']:
        return "end"
    if state['iterations'] > 3:  # Circuit breaker
        print("--- MAX ITERATIONS REACHED ---")
        return "end"
    return "debug"

# Build Graph
workflow = StateGraph(AgentState)

# Add Nodes
workflow.add_node("generate", write_code_node)
workflow.add_node("test_gen", write_tests_node)
workflow.add_node("execute", execute_node)
workflow.add_node("debug", debug_node)

# Set Entry Point
workflow.set_entry_point("generate")

# Add Edges
workflow.add_edge("generate", "test_gen")
workflow.add_edge("test_gen", "execute")

# Conditional Edge from Execution
workflow.add_conditional_edges(
    "execute",
    should_continue,
    {
        "end": END,
        "debug": "debug"
    }
)

# Loop back from Debug to Execute (skip test gen as tests remain valid)
workflow.add_edge("debug", "execute")

app = workflow.compile()
